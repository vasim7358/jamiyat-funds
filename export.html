<!DOCTYPE html>
const db = getDatabase(app);
await signInAnonymously(getAuth(app));


const rowsEl = document.getElementById('rows');
const totalEl = document.getElementById('total');


function csvEscape(v){
if (v === null || v === undefined) return '';
const s = String(v).replace(/\r?\n/g, ' ');
return /[",]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
}


async function load(){
const snap = await get(child(ref(db), 'funds'));
const data = snap.exists() ? snap.val() : {};
const list = Object.values(data).map(r => ({
date: r.date || '',
amount: Number(r.amount || 0),
notes: r.notes || '',
created_at: r.created_at || ''
})).sort((a,b)=> (a.date||'').localeCompare(b.date||''));


// table
rowsEl.innerHTML = list.length ? '' : '<tr><td colspan="4" class="muted">No entries yet.</td></tr>';
let total = 0;
for(const r of list){
total += r.amount || 0;
const tr = document.createElement('tr');
tr.innerHTML = `<td>${r.date}</td><td>${r.amount.toFixed(2)}</td><td>${r.notes}</td><td>${r.created_at}</td>`;
rowsEl.appendChild(tr);
}
totalEl.textContent = total.toFixed(2);


// csv
const header = ['Date','Amount','Notes','Created'];
const csv = [header.join(',')].concat(list.map(r => [csvEscape(r.date), csvEscape(r.amount), csvEscape(r.notes), csvEscape(r.created_at)].join(','))).join('\n');
document.getElementById('btnCsv').onclick = () => {
const blob = new Blob([csv + '\n'], {type:'text/csv'});
const url = URL.createObjectURL(blob);
const a = Object.assign(document.createElement('a'), { href:url, download:'jamiyat_funds.csv' });
document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
}


load().catch(e=>{
rowsEl.innerHTML = `<tr><td colspan="4" class="err">Error: ${e}</td></tr>`;
});
</script>
</body>
</html>
