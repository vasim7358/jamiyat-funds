<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jamiyat Funds Collection Kadegaon</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url("islamic-ramadan-celebration-lantern-fantasy-style.jpg") no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: white;
  }
  .container {
    background: rgba(0, 0, 0, 0.8);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
    width: 95%;
    max-width: 600px;
    position: relative;
  }
  h2 { text-align: center; margin-bottom: 15px; color: #ffd700; }
  label { display: block; margin: 8px 0 4px; }
  input { width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 6px; }
  .row {
    border: 1px solid #666;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    position: relative;
  }
  .remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #ff4d4d;
    color: white;
    font-weight: bold;
    font-size: 18px;
    border: none;
    cursor: pointer;
    text-align: center;
    line-height: 28px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: background 0.2s, transform 0.2s;
  }
  .remove-btn:hover { background-color: #cc0000; transform: scale(1.1); }
  button { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
  #addRowBtn { background: #ffc107; color: black; }
  #addRowBtn:hover { background: #e0a800; }
  #submitBtn { background: #28a745; color: white; }
  #submitBtn:hover { background: #218838; }
  .totals { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; }
  .totals p { margin: 5px 0; font-size: 16px; }
  #mainPage { display: none; }

  /* Menu Dropdown */
  .menu-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
  }
  .menu-dropdown {
    position: absolute;
    top: 45px;
    right: 15px;
    background: rgba(0,0,0,0.9);
    border-radius: 6px;
    display: none;
    flex-direction: column;
    z-index: 10;
  }
  .menu-dropdown button {
    width: 150px;
    margin: 0;
    border-radius: 0;
    border-bottom: 1px solid #555;
    background: none;
    color: white;
    text-align: left;
    padding: 10px;
  }
  .menu-dropdown button:last-child { border-bottom: none; }
  .menu-dropdown button:hover { background: #333; }

  /* Committee Modal */
  #committeeModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center; 
    align-items: center;
    z-index: 2000;
  }
  #committeeBox {
    background: #111; padding: 20px; border-radius: 10px; width: 350px; color: white;
  }
  #committeeBox h3 { text-align:center; color:#ffd700; margin-bottom:15px; }
  #committeeBox ul { list-style:none; padding:0; }
  #committeeBox li { margin:8px 0; }
  #closeCommittee { float:right; cursor:pointer; font-size:20px; color:red; }
</style>
</head>
<body>

<!-- Authentication Page -->
<div class="container" id="authPage">
  <h2>Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <input type="password" id="refKey" placeholder="Reference Key" required>
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <p id="authMsg" style="color:#ffd700;text-align:center;"></p>
</div>

<!-- Main Page -->
<div id="mainPage" class="container">
  <span class="menu-btn">â‹®</span>
  <div class="menu-dropdown" id="menuDropdown">
    <button id="menuDownloadCSV">Download CSV</button>
    <button id="menuDownloadPDF">Download PDF</button>
    <button id="menuCommittee">Committee</button>
    <button id="menuLogout">Logout</button>
  </div>

  <h2>Jamiyat Funds Collection Kadegaon</h2>
  <form id="fundForm">
    <div id="rows"></div>
    <button type="button" id="addRowBtn">âž• Add Member</button>
    <button type="submit" id="submitBtn">âœ… Submit All</button>
  </form>
  <div class="totals">
    <p><b>ðŸ“… This Month Collection:</b> <span id="monthTotal">0</span> â‚¹</p>
    <p><b>ðŸ’° Jamiyat's Total Collection:</b> <span id="grandTotal">0</span> â‚¹</p>
  </div>
</div>

<!-- Committee Modal -->
<div id="committeeModal">
  <div id="committeeBox">
    <span id="closeCommittee">Ã—</span>
    <h3>Jamiyat Committee</h3>
    <ul>
      <li>1. Sadar â€“ Hafiz Javed</li>
      <li>2. Na.Sadar â€“ Hafiz Azam</li>
      <li>3. Na.Sadar â€“ Anis shaha</li>
      <li>4. Nazim â€“Kausar baig</li>
      <li>5. Na.Nazim â€“ Asif molana</li>
      <li>6. Na.Nazim â€“ Vasim mirza</li>
      <li>7. Khajanchi â€“ Shahabaz khan</li>
      <li>8. Khajanchi â€“ Ansar shaha</li>
    </ul>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBelymTqSSpc6_WqTTIjdUSB4y4fyPalVQ",
  authDomain: "jamiyat-funds.firebaseapp.com",
  databaseURL: "https://jamiyat-funds-default-rtdb.firebaseio.com",
  projectId: "jamiyat-funds",
  storageBucket: "jamiyat-funds.firebasestorage.app",
  messagingSenderId: "86627932910",
  appId: "1:86627932910:web:224ff0986be22b900531ff",
  measurementId: "G-KB7XEYP9PV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const authPage = document.getElementById('authPage');
const mainPage = document.getElementById('mainPage');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const refKeyInput = document.getElementById('refKey');
const authMsg = document.getElementById('authMsg');

const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');

const REFERENCE_KEY = "masjid@786";
const CSV_PASSWORD = "jama@0078";

// Persistent login
firebase.auth().onAuthStateChanged(user => { if(user) showMainPage(); });

// Sign up
signupBtn.onclick = () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  const refKey = refKeyInput.value;
  if(refKey!==REFERENCE_KEY){ authMsg.textContent="âŒ Incorrect Reference Key"; return; }
  firebase.auth().createUserWithEmailAndPassword(email,password)
    .then(()=>{ authMsg.textContent="âœ… Sign Up successful. You can login now."; })
    .catch(err=>{ authMsg.textContent=err.message; });
};

// Login
loginBtn.onclick = () => {
  const email=emailInput.value;
  const password=passwordInput.value;
  firebase.auth().signInWithEmailAndPassword(email,password)
    .then(()=>{ showMainPage(); })
    .catch(err=>{ authMsg.textContent=err.message; });
};

// Show main page
function showMainPage(){
  authPage.style.display='none';
  mainPage.style.display='block';
  initMainPage();
}

// Menu toggle & outside click
const menuBtn=document.querySelector('.menu-btn');
const menuDropdown=document.getElementById('menuDropdown');
menuBtn.onclick=()=>{ menuDropdown.style.display=menuDropdown.style.display==='flex'?'none':'flex'; };
window.addEventListener("click",function(e){
  if(menuDropdown.style.display==="flex" && !menuDropdown.contains(e.target) && e.target!==menuBtn){
    menuDropdown.style.display="none";
  }
});

// Committee modal toggle
document.getElementById('menuCommittee').onclick=()=> document.getElementById('committeeModal').style.display="flex";
document.getElementById('closeCommittee').onclick=()=> document.getElementById('committeeModal').style.display="none";

// Logout & downloads
document.getElementById('menuLogout').onclick=()=> {
  firebase.auth().signOut().then(()=>{ localStorage.removeItem('user'); location.reload(); });
};
document.getElementById('menuDownloadCSV').onclick=()=> downloadCsvPrompt();
document.getElementById('menuDownloadPDF').onclick=()=> downloadPdf();

// Initialize main page
function initMainPage(){
  const rowsContainer=document.getElementById('rows');
  const form=document.getElementById('fundForm');
  const monthTotalEl=document.getElementById('monthTotal');
  const grandTotalEl=document.getElementById('grandTotal');

  function addRow(){
    const div=document.createElement('div');
    div.classList.add('row');
    div.innerHTML=`
      <label>Date:</label><input type="date" class="date" required>
      <label>Member Name:</label><input type="text" class="member" required>
      <label>Amount:</label><input type="number" class="amount" required>
      <label>Receiver:</label><input type="text" class="receiver" required>
      <button type="button" class="remove-btn" onclick="removeRow(this)">Ã—</button>
    `;
    rowsContainer.appendChild(div);
  }
  document.getElementById('addRowBtn').addEventListener('click', addRow);
  addRow();
  window.removeRow=function(button){ button.parentElement.remove(); };

  form.addEventListener('submit',function(e){
    e.preventDefault();
    const rows=document.querySelectorAll('.row');
    rows.forEach(row=>{
      const date=row.querySelector('.date').value;
      const member=row.querySelector('.member').value;
      const amount=row.querySelector('.amount').value;
      const receiver=row.querySelector('.receiver').value;
      db.ref('funds').push({date, member, amount, receiver});
    });
    alert('âœ… All data saved successfully!');
    rowsContainer.innerHTML='';
    addRow();
    updateTotals();
  });

  function updateTotals(){
    db.ref('funds').once('value',snapshot=>{
      const data=snapshot.val();
      if(!data) return;
      let grandTotal=0, monthTotal=0;
      const now=new Date();
      const thisMonth=now.getMonth()+1;
      const thisYear=now.getFullYear();
      for(let key in data){
        const row=data[key];
        const amount=parseFloat(row.amount)||0;
        grandTotal+=amount;
        const d=new Date(row.date);
        if(d.getMonth()+1===thisMonth && d.getFullYear()===thisYear) monthTotal+=amount;
      }
      monthTotalEl.textContent=monthTotal;
      grandTotalEl.textContent=grandTotal;
    });
  }

  updateTotals();
}

// CSV download with password
function downloadCsvPrompt(){
  const pwd=prompt("Enter password to download CSV:");
  if(pwd!==CSV_PASSWORD){ alert("âŒ Incorrect password"); return; }

  db.ref('funds').once('value',snapshot=>{
    const data=snapshot.val();
    if(!data){ alert("No records found."); return; }
    let csv="ID,DATE,MEMBER,AMOUNT,RECEIVER\n";
    let id=1, grandTotal=0;
    for(let key in data){
      const row=data[key];
      csv+=`${id},${row.date},${row.member},${row.amount},${row.receiver}\n`;
      grandTotal+=parseFloat(row.amount)||0;
      id++;
    }
    csv+=`Grand Total:,${grandTotal}\n`;
    const blob=new Blob([csv],{type:'text/csv'});
    const url=window.URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='jamiyat_funds.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });
}

// PDF download with password & proper table
function downloadPdf(){
  const pwd=prompt("Enter password to download PDF:");
  if(pwd!==CSV_PASSWORD){ alert("âŒ Incorrect password"); return; }

  db.ref('funds').once('value',snapshot=>{
    const data=snapshot.val();
    if(!data){ alert("No records found."); return; }

    const div=document.createElement('div');
    div.style.padding="20px";
    div.style.fontSize="14px";
    div.style.color="#000";
    div.style.background="#fff";

    const title=document.createElement('h3');
    title.innerText="Jamiyat Funds Collection";
    title.style.textAlign="center";
    div.appendChild(title);

    const table=document.createElement('table');
    table.style.width="100%";
    table.style.borderCollapse="collapse";
    table.style.marginTop="10px";

    const headerRow=document.createElement('tr');
    ["ID","Date","Member","Amount","Receiver"].forEach(h=>{
      const th=document.createElement('th');
      th.innerText=h;
      th.style.border="1px solid #000";
      th.style.padding="5px";
      th.style.background="#ffd700";
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    let id=1, total=0;
    for(let key in data){
      const row=data[key];
      const tr=document.createElement('tr');
      [id,row.date,row.member,row.amount,row.receiver].forEach(val=>{
        const td=document.createElement('td');
        td.innerText=val;
        td.style.border="1px solid #000";
        td.style.padding="5px";
        tr.appendChild(td);
      });
      total+=parseFloat(row.amount)||0;
      table.appendChild(tr);
      id++;
    }

    const trTotal=document.createElement('tr');
    ["","","Total",total,""].forEach(val=>{
      const td=document.createElement('td');
      td.innerText=val;
      td.style.border="1px solid #000";
      td.style.fontWeight=(val==="Total" || val===total)?"bold":"normal";
      td.style.padding="5px";
      trTotal.appendChild(td);
    });
    table.appendChild(trTotal);
    div.appendChild(table);

    html2pdf().from(div).save("jamiyat_funds.pdf");
  });
}
</script>
</body>
</html>
